import requests
import pandas as pd
import numpy as np
import matplotlib.pyplot as plt

# сначала получаем данные о ценах и популярности с market.csgo.com
MARKET_URL = "https://market.csgo.com/api/v2/prices/class_instance/RUB.json" # Это один из самых крупных сайтов по продаже скинов 

resp_market = requests.get(MARKET_URL)
resp_market.raise_for_status()
market_json = resp_market.json()
market_items = market_json["items"]

market_rows = []

def to_float(x): # пытаемся перевести в float, так как может быть беда беда
    try:
        return float(x)
    except (TypeError, ValueError):
        return None

def to_int(x): # тут то же самое
    try:
        return int(x)
    except (TypeError, ValueError):
        return None

for j, item in market_items.items():
    name = item.get("market_hash_name")
    if not name:
        continue

    market_rows.append(
        {"market_hash_name": name,
         "market_price_rub": to_float(item.get("price")),
          "market_avg_price_rub": to_float(item.get("avg_price")),
          "market_buy_order_rub": to_float(item.get("buy_order")),
          "market_popularity_7d": to_int(item.get("popularity_7d")),
          "market_ru_rarity": item.get("ru_rarity"),
          "market_ru_quality": item.get("ru_quality")
        }
    )

df_market = pd.DataFrame(market_rows) # Первая половина есть, но нам мало колонок

# тянем доп инфу по скинам с кс го апи, чтобы прибавить инфы для анализа 
SKINS_URL = "https://raw.githubusercontent.com/ByMykel/CSGO-API/main/public/api/en/skins_not_grouped.json"

resp_skins = requests.get(SKINS_URL)
resp_skins.raise_for_status()
skins_json = resp_skins.json()

skins_rows = []

for skin in skins_json:
    name = skin.get("market_hash_name")
    if not name:
        continue

    weapon = skin.get("weapon") or {}
    pattern = skin.get("pattern") or {}

    skins_rows.append(
        {
            "market_hash_name": name,
            "weapon_name": weapon.get("name"),
            "float_min": skin.get("min_float"),
            "float_max": skin.get("max_float"),
            "pattern_name": pattern.get("name"),
            "is_stattrak": bool(skin.get("stattrak")),
            "is_souvenir": bool(skin.get("souvenir")),
        }
    )

df_skins = pd.DataFrame(skins_rows)

# объединяем две таблицы по market_hash_name и убираем пропуски
# это надо для того чтобы работать с фулл заполненой таблицей со всеми крутыми ячейками
df_full = df_market.merge(df_skins, on="market_hash_name", how="inner")
df_full = df_full.replace("", pd.NA)
df_clean = df_full.dropna(how="any")


# сортировка: сначала описание предмета, затем характеристики, потом цены/популярность
cols_order = [
    "market_hash_name",
    "weapon_name",
    "pattern_name",
    "is_stattrak",
    "is_souvenir",
    "market_ru_rarity",
    "market_ru_quality",
    "float_min",
    "float_max",
    "market_price_rub",
    "market_avg_price_rub",
    "market_buy_order_rub",
    "market_popularity_7d",
]

df_clean = df_clean[cols_order]

# сохраняем итоговую таблицу 
df_clean.to_csv("cs2_items.csv", index=False, encoding="utf-8-sig")

# для анализа дальше используем копию этой таблицы
df = df_clean.copy()


df["spread_price_buy"] = df["market_price_rub"] - df["market_buy_order_rub"] # считаем спред цены
avg = df["market_avg_price_rub"].replace(0, np.nan)
df["price_to_avg_ratio"] = df["market_price_rub"] / avg # отношение текущей цены к средней


# распределения по категориям и описательная статистика по числам.

total_missing = int(df.isna().sum().sum())
print("Общее количество пропусков:", total_missing)
print("")
dup_count = df.duplicated().sum() # тут убираем дубликаты они нам не нужны мы индивиды в этом бренном мире
print("Полных дубликатов:", dup_count)
print("")
if dup_count > 0:
    df = df.drop_duplicates()

# тут дальше вроде все чисто и ясно как солнце и небо в летние деньки 

print("Уникальных предметов:", df["market_hash_name"].nunique())
print("")
print("Уникальных видов оружия:  ", df["weapon_name"].nunique())
print("")
print("Распределение по редкости:")
print("")
print(df["market_ru_rarity"].value_counts())
print("")
print("Распределение по качеству:")
print(df["market_ru_quality"].value_counts())
print("")
print("Доля статтрековских:", df["is_stattrak"].mean())
print("")
print("Доля сувенирных:", df["is_souvenir"].mean())
print("")
print("Описательная статистика по текущей цене:")
print(df["market_price_rub"].describe())
print("")
print("Описательная статистика по популярности:")
print(df["market_popularity_7d"].describe())
print("")
print("Описательная статистика по отношение текущей цены к средней:")
print(df["price_to_avg_ratio"].describe())
print("")

# меняется ли средняя цена и популярность по редкости и качеству, набиваем крч говоря побольше характеристик
mean_price_by_rarity = (df.groupby("market_ru_rarity")["market_price_rub"].mean().sort_values(ascending=False))
print("Средняя цена по редкости:")
print(mean_price_by_rarity)
print("")

# стата по редкости и популярности
mean_pop_by_rarity = (df.groupby("market_ru_rarity")["market_popularity_7d"].mean().sort_values(ascending=False))
print("Средняя популярность по редкости:")
print(mean_pop_by_rarity)
print("")

# стата по качеству и цене
mean_price_by_quality = (df.groupby("market_ru_quality")["market_price_rub"].mean().sort_values(ascending=False))
print("Средняя цена по качеству:")
print(mean_price_by_quality)
print("")

# корреляции между ценой, средней ценой, ценой на оредер покупки, популярностью, спреду
corr_cols = ["market_price_rub",
             "market_avg_price_rub",
             "market_buy_order_rub",
             "market_popularity_7d",
             "spread_price_buy"]
corr = df[corr_cols].corr()
print("Корреляция числовых признаков:")
print(corr)
print("")



#Тут начианем клипать графики, сначала простые
# гистограмма маркет прайса и кол-ва предметов 1
plt.figure()
df["market_price_rub"].hist(bins=50)
plt.xlabel("Цена, руб.")
plt.ylabel("Количество предметов")
plt.title("Распределение цен предметов CS2")
plt.yscale("log")
plt.tight_layout()
plt.show()

# гистограмма популярности и кол-ва предметов в обороте маркета 2
plt.figure()
df["market_popularity_7d"].hist(bins=50)
plt.xlabel("Популярность за 7 дней")
plt.ylabel("Количество предметов")
plt.title("Распределение популярности предметов")
plt.yscale("log")
plt.tight_layout()
plt.show()

# боксплот цены по редкости 3
plt.figure()
df.boxplot(column="market_price_rub", by="market_ru_rarity", rot=60)
plt.ylabel("Цена, руб.")
plt.title("Цена по редкости")
plt.xlabel("")
plt.suptitle("")
plt.tight_layout()
plt.show()

# средняя цена по редкости 4
plt.figure()
mean_price_by_rarity.plot(kind="bar")
plt.ylabel("Средняя цена, руб.")
plt.title("Средняя цена по редкости")
plt.xlabel("")
plt.xticks(rotation=60)
plt.tight_layout()
plt.show()

# Количество предметов по редкости 5
plt.figure()
df["market_ru_rarity"].value_counts().plot(kind="bar")
plt.ylabel("Количество предметов")
plt.title("Количество предметов по редкости")
plt.xlabel("")
plt.xticks(rotation=60)
plt.tight_layout()
plt.show()

# график цена и популярность
plt.figure()
plt.scatter(df["market_price_rub"], df["market_popularity_7d"])
plt.xlabel("Цена, руб.")
plt.ylabel("Популярность за 7 дней в пуле маркета")
plt.title("Цена/популярность")
plt.xscale("log")
plt.yscale("log")
plt.tight_layout()
plt.show()

#  график текущая цена vs средняя цена
plt.figure()
plt.scatter(df["market_avg_price_rub"], df["market_price_rub"])
plt.xlabel("Средняя цена, руб.")
plt.ylabel("Текущая цена, руб.")
plt.title("Текущая цена/средняя цена")
plt.xscale("log")
plt.yscale("log")
plt.tight_layout()
plt.show()

# доля статрек предметов топ 10 
st_share_by_weapon = (
    df.groupby("weapon_name")["is_stattrak"]
    .mean()
    .sort_values(ascending=False)
    .head(10)
)
plt.figure()
st_share_by_weapon.plot(kind="bar")
plt.ylabel("Доля StatTrak")
plt.title("Доля StatTrak предметов")
plt.xticks(rotation=45)
plt.tight_layout()
plt.show()

# 20 самых популярных предметов на маркете
top_popular = df.sort_values("market_popularity_7d", ascending=False).head(20)
plt.figure()
plt.barh(top_popular["market_hash_name"], top_popular["market_popularity_7d"])
plt.xlabel("Популярность за 7 дней")
plt.title("20 сымых популярных предметов")
plt.gca().invert_yaxis()
plt.tight_layout()
plt.show()

# тепловая карта корреляций которые мы до этого уже посчитали и вывели в прошлом пункте 
plt.figure()
plt.imshow(corr, interpolation="nearest")
plt.xticks(range(len(corr)), corr.columns, rotation=90)
plt.yticks(range(len(corr)), corr.columns)
plt.colorbar()
plt.title("Корреляции числовых признаков")
plt.tight_layout()
plt.show()




