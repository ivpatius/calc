import pandas as pd
import numpy as np
import matplotlib.pyplot as plt

# настройки отображения
pd.set_option("display.max_rows", 50)
pd.set_option("display.max_columns", 50)
pd.set_option("display.width", 120)
pd.set_option("display.float_format", lambda x: f"{x:.2f}")  # без экспоненциальной записи
np.set_printoptions(suppress=True)

# загружаем подготовленный датасет
df = pd.read_csv("cs2_items_clean.csv")

# дополнительные метрики
df["spread_price_buy"] = df["market_price_rub"] - df["market_buy_order_rub"]
denom = df["market_avg_price_rub"].replace(0, np.nan)
df["price_to_avg_ratio"] = df["market_price_rub"] / denom
df["log_price"] = np.log1p(df["market_price_rub"])

print("=== Общая информация ===")
print("Размер датасета (строки, колонки):", df.shape)
print("\nПропуски по столбцам:")
print(df.isna().sum())

dup_count = df.duplicated().sum()
print("\nКоличество полных дубликатов:", dup_count)
if dup_count > 0:
    df = df.drop_duplicates()
    print("Размер после удаления дублей:", df.shape)

print("\nУникальных предметов (market_hash_name):", df["market_hash_name"].nunique())
print("Уникальных видов оружия (weapon_name):  ", df["weapon_name"].nunique())

print("\nРаспределение по редкости:")
print(df["market_ru_rarity"].value_counts())

print("\nРаспределение по качеству:")
print(df["market_ru_quality"].value_counts())

print("\nДоля StatTrak:", df["is_stattrak"].mean())
print("Доля Souvenir:", df["is_souvenir"].mean())

print("\nОписательная статистика по цене (market_price_rub):")
print(df["market_price_rub"].describe())

print("\nОписательная статистика по популярности (market_popularity_7d):")
print(df["market_popularity_7d"].describe())

print("\nОписательная статистика по price_to_avg_ratio:")
print(df["price_to_avg_ratio"].describe())

# группировки
mean_price_by_rarity = (
    df.groupby("market_ru_rarity")["market_price_rub"]
    .mean()
    .sort_values(ascending=False)
)
print("\nСредняя цена по редкости:")
print(mean_price_by_rarity)

mean_pop_by_rarity = (
    df.groupby("market_ru_rarity")["market_popularity_7d"]
    .mean()
    .sort_values(ascending=False)
)
print("\nСредняя популярность по редкости:")
print(mean_pop_by_rarity)

mean_price_by_quality = (
    df.groupby("market_ru_quality")["market_price_rub"]
    .mean()
    .sort_values(ascending=False)
)
print("\nСредняя цена по качеству:")
print(mean_price_by_quality)

# корреляции
corr_cols = [
    "market_price_rub",
    "market_avg_price_rub",
    "market_buy_order_rub",
    "market_popularity_7d",
    "spread_price_buy",
    "price_to_avg_ratio",
    "log_price",
]
corr = df[corr_cols].corr()
print("\nКорреляция числовых признаков:")
print(corr)

# простая "модель" ожидаемой цены по группам
group_cols = ["market_ru_rarity", "market_ru_quality", "is_stattrak", "is_souvenir"]
df_model = df.copy()

group_mean_price = (
    df_model.groupby(group_cols)["market_price_rub"]
    .mean()
    .reset_index()
    .rename(columns={"market_price_rub": "expected_price_group"})
)

df_model = df_model.merge(group_mean_price, on=group_cols, how="left")
df_model["price_deviation"] = df_model["market_price_rub"] - df_model["expected_price_group"]

print("\nТоп-10 предметов с максимальным завышением относительно своей группы:")
print(
    df_model.sort_values("price_deviation", ascending=False)[
        [
            "market_hash_name",
            "market_ru_rarity",
            "market_ru_quality",
            "is_stattrak",
            "is_souvenir",
            "market_price_rub",
            "expected_price_group",
            "price_deviation",
        ]
    ].head(10)
)

print("\nТоп-10 предметов с максимальным занижением относительно своей группы:")
print(
    df_model.sort_values("price_deviation", ascending=True)[
        [
            "market_hash_name",
            "market_ru_rarity",
            "market_ru_quality",
            "is_stattrak",
            "is_souvenir",
            "market_price_rub",
            "expected_price_group",
            "price_deviation",
        ]
    ].head(10)
)

# ==========================
# ВИЗУАЛИЗАЦИИ
# ==========================

# 1. распределение цен
plt.figure()
df["market_price_rub"].hist(bins=50)
plt.xlabel("Цена, руб.")
plt.ylabel("Количество предметов")
plt.title("Распределение цен предметов CS2")
plt.yscale("log")
plt.tight_layout()
plt.show()

# 2. распределение популярности
plt.figure()
df["market_popularity_7d"].hist(bins=50)
plt.xlabel("Популярность за 7 дней")
plt.ylabel("Количество предметов")
plt.title("Распределение популярности предметов")
plt.yscale("log")
plt.tight_layout()
plt.show()

# 3. распределение спреда цена - buy order
plt.figure()
df["spread_price_buy"].hist(bins=50)
plt.xlabel("Цена - buy order, руб.")
plt.ylabel("Количество предметов")
plt.title("Распределение спреда между ценой и лучшим buy order")
plt.tight_layout()
plt.show()

# 4. boxplot цены по редкости
plt.figure()
df.boxplot(column="market_price_rub", by="market_ru_rarity", rot=45)
plt.ylabel("Цена, руб.")
plt.title("Цена по редкости")
plt.suptitle("")
plt.tight_layout()
plt.show()

# 5. средняя цена по редкости
plt.figure()
mean_price_by_rarity.plot(kind="bar")
plt.ylabel("Средняя цена, руб.")
plt.title("Средняя цена по редкости")
plt.xticks(rotation=45)
plt.tight_layout()
plt.show()

# 6. количество предметов по редкости
plt.figure()
df["market_ru_rarity"].value_counts().plot(kind="bar")
plt.ylabel("Количество предметов")
plt.title("Количество предметов по редкости")
plt.xticks(rotation=45)
plt.tight_layout()
plt.show()

# 7. цена vs популярность
plt.figure()
plt.scatter(df["market_price_rub"], df["market_popularity_7d"])
plt.xlabel("Цена, руб.")
plt.ylabel("Популярность за 7 дней")
plt.title("Цена и популярность")
plt.xscale("log")
plt.yscale("log")
plt.tight_layout()
plt.show()

# 8. текущая цена vs средняя цена
plt.figure()
plt.scatter(df["market_avg_price_rub"], df["market_price_rub"])
plt.xlabel("Средняя цена, руб.")
plt.ylabel("Текущая цена, руб.")
plt.title("Текущая цена и средняя цена")
plt.xscale("log")
plt.yscale("log")
plt.tight_layout()
plt.show()

# 9. доля StatTrak по оружию (топ-10)
st_share_by_weapon = (
    df.groupby("weapon_name")["is_stattrak"]
    .mean()
    .sort_values(ascending=False)
    .head(10)
)
plt.figure()
st_share_by_weapon.plot(kind="bar")
plt.ylabel("Доля StatTrak")
plt.title("Доля StatTrak по оружию (топ-10)")
plt.xticks(rotation=45)
plt.tight_layout()
plt.show()

# 10. топ-20 самых популярных предметов
top_popular = df.sort_values("market_popularity_7d", ascending=False).head(20)
plt.figure()
plt.barh(top_popular["market_hash_name"], top_popular["market_popularity_7d"])
plt.xlabel("Популярность за 7 дней")
plt.title("Топ-20 популярных предметов")
plt.gca().invert_yaxis()
plt.tight_layout()
plt.show()

# 11. корреляции (тепловая карта)
plt.figure()
plt.imshow(corr, interpolation="nearest")
plt.xticks(range(len(corr)), corr.columns, rotation=90)
plt.yticks(range(len(corr)), corr.columns)
plt.colorbar()
plt.title("Корреляции числовых признаков")
plt.tight_layout()
plt.show()