import requests
import pandas as pd
import numpy as np
import matplotlib.pyplot as plt

# базовые настройки отображения в pandas / numpy
pd.set_option("display.max_rows", 50)
pd.set_option("display.max_columns", 50)
pd.set_option("display.width", 120)
pd.set_option("display.float_format", lambda x: f"{x:.2f}")
np.set_printoptions(suppress=True)

# =====================================
# 1–2. Сбор данных и формирование таблицы
# =====================================

# Сначала получаем данные о ценах и популярности с market.csgo.com
MARKET_URL = "https://market.csgo.com/api/v2/prices/class_instance/RUB.json"

resp_market = requests.get(MARKET_URL)
resp_market.raise_for_status()
market_json = resp_market.json()
market_items = market_json["items"]

market_rows = []

def to_float(x):
    # Пробуем привести к float, если не получается — возвращаем None
    try:
        return float(x)
    except (TypeError, ValueError):
        return None

def to_int(x):
    # Пробуем привести к int, если не получается — возвращаем None
    try:
        return int(x)
    except (TypeError, ValueError):
        return None

for _, item in market_items.items():
    name = item.get("market_hash_name")
    if not name:
        continue

    market_rows.append(
        {
            "market_hash_name": name,
            "market_price_rub": to_float(item.get("price")),
            "market_avg_price_rub": to_float(item.get("avg_price")),
            "market_buy_order_rub": to_float(item.get("buy_order")),
            "market_popularity_7d": to_int(item.get("popularity_7d")),
            "market_ru_rarity": item.get("ru_rarity"),
            "market_ru_quality": item.get("ru_quality"),
        }
    )

df_market = pd.DataFrame(market_rows)

# Теперь подтягиваем дополнительную информацию по скинам из CSGO-API (ByMykel)
SKINS_URL = "https://raw.githubusercontent.com/ByMykel/CSGO-API/main/public/api/en/skins_not_grouped.json"

resp_skins = requests.get(SKINS_URL)
resp_skins.raise_for_status()
skins_json = resp_skins.json()

skins_rows = []

for skin in skins_json:
    name = skin.get("market_hash_name")
    if not name:
        continue

    weapon = skin.get("weapon") or {}
    pattern = skin.get("pattern") or {}

    skins_rows.append(
        {
            "market_hash_name": name,
            "weapon_name": weapon.get("name"),
            "float_min": skin.get("min_float"),
            "float_max": skin.get("max_float"),
            "pattern_name": pattern.get("name"),
            "is_stattrak": bool(skin.get("stattrak")),
            "is_souvenir": bool(skin.get("souvenir")),
        }
    )

df_skins = pd.DataFrame(skins_rows)

# Объединяем две таблицы по market_hash_name и убираем строки с пропусками
df_full = df_market.merge(df_skins, on="market_hash_name", how="inner")
df_full = df_full.replace("", pd.NA)
df_clean = df_full.dropna(how="any")

# Приводим столбцы в удобный порядок:
# сначала описание предмета, затем характеристики, потом цены/популярность
cols_order = [
    "market_hash_name",
    "weapon_name",
    "pattern_name",
    "is_stattrak",
    "is_souvenir",
    "market_ru_rarity",
    "market_ru_quality",
    "float_min",
    "float_max",
    "market_price_rub",
    "market_avg_price_rub",
    "market_buy_order_rub",
    "market_popularity_7d",
]

df_clean = df_clean[cols_order]

# Сохраняем итоговую таблицу для дальнейшей работы
df_clean.to_csv("cs2_items.csv", index=False, encoding="utf-8-sig")

# Для анализа дальше используем копию этой таблицы
df = df_clean.copy()

# =====================================
# 3. Базовый анализ в pandas
# =====================================

# Здесь добавляем несколько вспомогательных метрик:
# 1) разница между текущей ценой и лучшим buy order
# 2) отношение текущей цены к средней
# 3) логарифм цены для более ровного распределения
df["spread_price_buy"] = df["market_price_rub"] - df["market_buy_order_rub"]
denom = df["market_avg_price_rub"].replace(0, np.nan)
df["price_to_avg_ratio"] = df["market_price_rub"] / denom
df["log_price"] = np.log1p(df["market_price_rub"])

# Ниже — несколько базовых характеристик: дубли, уникальные значения,
# распределения по категориям и описательная статистика по числам.

total_missing = int(df.isna().sum().sum())
print("Общее количество пропусков:", total_missing)

dup_count = df.duplicated().sum()
print("Полных дубликатов:", dup_count)
if dup_count > 0:
    df = df.drop_duplicates()

print("\nУникальных предметов (market_hash_name):", df["market_hash_name"].nunique())
print("Уникальных видов оружия (weapon_name):  ", df["weapon_name"].nunique())

print("\nРаспределение по редкости:")
print(df["market_ru_rarity"].value_counts())

print("\nРаспределение по качеству:")
print(df["market_ru_quality"].value_counts())

print("\nДоля StatTrak:", df["is_stattrak"].mean())
print("Доля Souvenir:", df["is_souvenir"].mean())

print("\nОписательная статистика по цене (market_price_rub):")
print(df["market_price_rub"].describe())

print("\nОписательная статистика по популярности (market_popularity_7d):")
print(df["market_popularity_7d"].describe())

print("\nОписательная статистика по price_to_avg_ratio:")
print(df["price_to_avg_ratio"].describe())

# Смотрим, как меняется средняя цена и популярность по редкости и качеству
mean_price_by_rarity = (
    df.groupby("market_ru_rarity")["market_price_rub"]
    .mean()
    .sort_values(ascending=False)
)
print("\nСредняя цена по редкости:")
print(mean_price_by_rarity)

mean_pop_by_rarity = (
    df.groupby("market_ru_rarity")["market_popularity_7d"]
    .mean()
    .sort_values(ascending=False)
)
print("\nСредняя популярность по редкости:")
print(mean_pop_by_rarity)

mean_price_by_quality = (
    df.groupby("market_ru_quality")["market_price_rub"]
    .mean()
    .sort_values(ascending=False)
)
print("\nСредняя цена по качеству:")
print(mean_price_by_quality)

# Корреляции между ценой, средней ценой, buy order, популярностью и нашими метриками
corr_cols = [
    "market_price_rub",
    "market_avg_price_rub",
    "market_buy_order_rub",
    "market_popularity_7d",
    "spread_price_buy",
    "price_to_avg_ratio",
    "log_price",
]
corr = df[corr_cols].corr()
print("\nКорреляция числовых признаков:")
print(corr)

# Простая «ожидаемая» цена по комбинации признаков:
# редкость, качество, StatTrak, Souvenir
group_cols = ["market_ru_rarity", "market_ru_quality", "is_stattrak", "is_souvenir"]
df_model = df.copy()

group_mean_price = (
    df_model.groupby(group_cols)["market_price_rub"]
    .mean()
    .reset_index()
    .rename(columns={"market_price_rub": "expected_price_group"})
)

df_model = df_model.merge(group_mean_price, on=group_cols, how="left")
df_model["price_deviation"] = df_model["market_price_rub"] - df_model["expected_price_group"]

print("\nТоп-10 предметов с максимальным завышением относительно своей группы:")
print(
    df_model.sort_values("price_deviation", ascending=False)[
        [
            "market_hash_name",
            "market_ru_rarity",
            "market_ru_quality",
            "is_stattrak",
            "is_souvenir",
            "market_price_rub",
            "expected_price_group",
            "price_deviation",
        ]
    ].head(10)
)

print("\nТоп-10 предметов с максимальным занижением относительно своей группы:")
print(
    df_model.sort_values("price_deviation", ascending=True)[
        [
            "market_hash_name",
            "market_ru_rarity",
            "market_ru_quality",
            "is_stattrak",
            "is_souvenir",
            "market_price_rub",
            "expected_price_group",
            "price_deviation",
        ]
    ].head(10)
)

# =====================================
# 4. Графики в matplotlib
# =====================================

# Гистограмма цен
plt.figure()
df["market_price_rub"].hist(bins=50)
plt.xlabel("Цена, руб.")
plt.ylabel("Количество предметов")
plt.title("Распределение цен предметов CS2")
plt.yscale("log")
plt.tight_layout()
plt.show()

# Гистограмма популярности
plt.figure()
df["market_popularity_7d"].hist(bins=50)
plt.xlabel("Популярность за 7 дней")
plt.ylabel("Количество предметов")
plt.title("Распределение популярности предметов")
plt.yscale("log")
plt.tight_layout()
plt.show()

# Гистограмма отношения текущей цены к средней
plt.figure()
df["price_to_avg_ratio"].hist(bins=50)
plt.xlabel("Текущая цена / средняя цена")
plt.ylabel("Количество предметов")
plt.title("Распределение отношения текущей цены к средней")
plt.tight_layout()
plt.show()

# Boxplot цены по редкости
plt.figure()
df.boxplot(column="market_price_rub", by="market_ru_rarity", rot=45)
plt.ylabel("Цена, руб.")
plt.title("Цена по редкости")
plt.suptitle("")
plt.tight_layout()
plt.show()

# Средняя цена по редкости (barplot)
plt.figure()
mean_price_by_rarity.plot(kind="bar")
plt.ylabel("Средняя цена, руб.")
plt.title("Средняя цена по редкости")
plt.xticks(rotation=45)
plt.tight_layout()
plt.show()

# Количество предметов по редкости
plt.figure()
df["market_ru_rarity"].value_counts().plot(kind="bar")
plt.ylabel("Количество предметов")
plt.title("Количество предметов по редкости")
plt.xticks(rotation=45)
plt.tight_layout()
plt.show()

# Scatter: цена vs популярность
plt.figure()
plt.scatter(df["market_price_rub"], df["market_popularity_7d"])
plt.xlabel("Цена, руб.")
plt.ylabel("Популярность за 7 дней")
plt.title("Цена и популярность")
plt.xscale("log")
plt.yscale("log")
plt.tight_layout()
plt.show()

# Scatter: текущая цена vs средняя цена
plt.figure()
plt.scatter(df["market_avg_price_rub"], df["market_price_rub"])
plt.xlabel("Средняя цена, руб.")
plt.ylabel("Текущая цена, руб.")
plt.title("Текущая цена и средняя цена")
plt.xscale("log")
plt.yscale("log")
plt.tight_layout()
plt.show()

# Доля StatTrak по оружию (топ-10)
st_share_by_weapon = (
    df.groupby("weapon_name")["is_stattrak"]
    .mean()
    .sort_values(ascending=False)
    .head(10)
)
plt.figure()
st_share_by_weapon.plot(kind="bar")
plt.ylabel("Доля StatTrak")
plt.title("Доля StatTrak по оружию (топ-10)")
plt.xticks(rotation=45)
plt.tight_layout()
plt.show()

# Топ-20 самых популярных предметов
top_popular = df.sort_values("market_popularity_7d", ascending=False).head(20)
plt.figure()
plt.barh(top_popular["market_hash_name"], top_popular["market_popularity_7d"])
plt.xlabel("Популярность за 7 дней")
plt.title("Топ-20 популярных предметов")
plt.gca().invert_yaxis()
plt.tight_layout()
plt.show()

# Тепловая карта корреляций
plt.figure()
plt.imshow(corr, interpolation="nearest")
plt.xticks(range(len(corr)), corr.columns, rotation=90)
plt.yticks(range(len(corr)), corr.columns)
plt.colorbar()
plt.title("Корреляции числовых признаков")
plt.tight_layout()
plt.show()